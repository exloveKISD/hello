<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Proxy Timeout Test — External JS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #0b1020; color: #e6e9f0; }
    .wrap { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
    .card { width: 100%; max-width: 760px; background: #141a33; border: 1px solid #253056; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0 0 .5rem; font-size: 1.25rem; }
    p.muted { color: #9fb0d1; margin-top: .25rem; }
    .row { display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
    .badge { background: #1f2747; border: 1px solid #2e3b6b; padding: .35rem .6rem; border-radius: 999px; font-variant-numeric: tabular-nums; }
    button { background: #2a3770; color: #fff; border: 1px solid #3a4aa0; border-radius: 10px; padding: .55rem .8rem; cursor: pointer; }
    button:hover { filter: brightness(1.12); }
    code { background: #1a2244; border: 1px solid #2a3a7a; padding: .15rem .35rem; border-radius: 6px; }
    .ok { color: #65e39a; }
    .warn { color: #ffda6b; }
    .err { color: #ff7b7b; }
    hr { border: 0; border-top: 1px solid #253056; margin: 1rem 0; }
  </style>

  <script>
    function setStatus(text, cls) {
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = cls;
    }

    let startTime, raf;
    function startTimer() {
      startTime = performance.now();
      function tick(now) {
        const s = (now - startTime) / 1000;
        document.getElementById('elapsed').textContent = s.toFixed(1) + 's';
        raf = requestAnimationFrame(tick);
      }
      raf = requestAnimationFrame(tick);
    }
    function stopTimer() { if (raf) cancelAnimationFrame(raf); }

    function probeDone(kind) {
      stopTimer();
      if (kind === 'load') {
        setStatus('Completed: external JS finished downloading (load).', 'ok');
      } else if (kind === 'error') {
        setStatus('Completed: external JS ended with error (likely timeout/abort).', 'err');
      }
    }

    function delayedUrl(ms) {
      const seconds = Math.ceil(ms / 1000);
      return `https://httpbin.org/delay/${seconds}`;
      // Alternate if blocked:
      // return `https://httpstat.us/200?sleep=${ms}`;
    }

    function runTest(ms) {
      document.getElementById('currentDelay').textContent = ms.toLocaleString() + ' ms';
      setStatus('Loading external JS… (waiting for network)', 'warn');
      document.getElementById('resultNotes').textContent =
        'The page will not fully load until the external script finishes or errors.';
      document.getElementById('probeHost').textContent = delayedUrl(ms);

      const old = document.getElementById('probe');
      if (old) old.remove();

      const s = document.createElement('script');
      s.id = 'probe';
      s.defer = true;
      s.src = delayedUrl(ms) + `?cb=${Date.now()}`;
      s.onload = () => probeDone('load');
      s.onerror = () => probeDone('error');

      startTimer();
      const watchdog = 25000;
      clearTimeout(runTest._wdt);
      runTest._wdt = setTimeout(() => {
        setStatus(`Still waiting after ${watchdog/1000}s… (proxy may have timed out at 15s)`, 'warn');
      }, watchdog);

      document.head.appendChild(s);
    }

    document.addEventListener('DOMContentLoaded', () => runTest(30000));
    window.addEventListener('load', () => {
      document.getElementById('onloadFired').textContent = 'window.onload fired (page fully loaded).';
    });
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Proxy Timeout Test — External JavaScript</h1>
      <p class="muted">
        This page fetches an external <code>&lt;script&gt;</code> that deliberately delays its response.
        Many proxies kill pages that haven’t finished loading within their threshold (e.g., 15 s).
      </p>

      <div class="row">
        <span>Delay target:</span>
        <button onclick="runTest(10000)">10s</button>
        <button onclick="runTest(20000)">20s</button>
        <button onclick="runTest(30000)">30s</button>
        <button onclick="runTest(60000)">60s</button>
        <span class="badge">Current: <span id="currentDelay">30,000 ms</span></span>
      </div>

      <hr />

      <div class="row">
        <div>Elapsed: <span class="badge" id="elapsed">0.0s</span></div>
        <div>Status: <span id="status" class="warn">Waiting…</span></div>
      </div>

      <p class="muted" id="resultNotes"></p>
      <p class="muted">Probe URL: <code id="probeHost"></code></p>
      <p class="ok" id="onloadFired"></p>

      <hr />
      <p class="muted">
        If your network blocks <code>httpbin.org</code>, edit <code>delayedUrl(ms)</code> to use
        <code>https://httpstat.us/200?sleep=&lt;ms&gt;</code>.  
        The browser waits for the script fetch to complete (or fail), which exposes how your proxy handles delayed loads.
      </p>
    </div>
  </div>
</body>
</html>
